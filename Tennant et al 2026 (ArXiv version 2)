---
title: "Lord's Paradox Simulation Code for Tennant et al 2026"
author: "Peter Tennant"
---

**Last updated**: 13 February 2026

**Github**: <https://github.com/pwgtennant/lords-paradox>

# Introduction

This is the simulation and analytical code to accompany the research article entitled, "*Lord's 'paradox' explained: The 50-year warning on the use of 'change scores' in observational data*". The code was initially prepared by [Peter Tennant](https://medicinehealth.leeds.ac.uk/medicine/staff/815/dr-peter-wg-tennant) (University of Leeds and Alan Turing Institute) during 2022-2023 for the original [ArXiv preprint](https://arxiv.org/abs/2302.01822v1). It was updated during 2023-2024 during peer-review with the [American Journal of Epidemiology](https://academic.oup.com/aje), and again in 2025-2026 to accompany the updated [ArXiv preprint](https://arxiv.org/abs/2302.01822v2) and for resubmission to [Epidemiology](https://journals.lww.com/epidem/pages/default.aspx)

Peter Tennant acts as the guarantor for the accuracy of the work.

The code was run using R 4.5.2 and Python 3.11 but relies on several other packages that must be installed for the code to run.

The underlying simulations are performed in `DagSim` framework. This is called and executed within this R notebook using the `reticulate` package. Further details of `DagSim` are available in [Al Hajj et al 2023](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0284443).

## Overview of simulation

Two data structures are simulated, the first simulation (**scenario1**) does not include mediator-outcome confounding, the second simulation (**scenario2**) does include mediator-outcome confounding.

The simulation and analysis takes place in two stages,

1.  In the first stage, two datasets are simulated for the two scenarios (with and without mediator-outcome confounding); these are used to create plots (which form Figure 3 and Supplementary Figure 1 in Tennant et al 2026).

2.  In the second stage, multiple datasets are simulated for the two scenarios and various models are run and their coefficients stored.

The median coefficients and the 2.5th and 97.5th centiles for the two scenarios are then determined to form the simulation results.

**NOTE**: This code will create the following files in your working directory:

-   Two CSVs containing simulated datasets for the two scenarios

-   A CSV containing the model coefficient estimates for all models in the two scenarios

-   Two PNG files for the two plots

# Set-up

## Install and load necessary packages

First, we load the necessary R packages:

```{r r-setup}

r_packages <- c("plyr", 
                "dplyr",
                "tidyverse",
                "psych",
                "ggplot2",
                "gridExtra",
                "devtools",
                "showtext",
                "reticulate",
                "progress",
                "CMAverse"
                )

# Perform check whether any packages are required and install if missing
missing_r_packages  <- r_packages[!(r_packages %in% installed.packages()[,"Package"])]
if (length(missing_r_packages)) install.packages(missing_r_packages)
if (!("CMAverse" %in% installed.packages()[,"Package"])) devtools::install_github("BS1125/CMAverse")

# Load the required packages ----  
for (package in 1:length(r_packages)) suppressPackageStartupMessages(library(r_packages[package], character.only = TRUE))

#Remove the superfluous lists
rm(list=c("package", "missing_r_packages", "r_packages"))

# Import python essentials
py_require(c("dagsim", "numpy", "pandas"))  # near the top of the script

ds <- import("dagsim.base")
np <- import("numpy")
pd <- import("pandas")

# Function to convert pandas datagrames to r dataframes
pandas_to_r <- function(pdf) {
  # Convert to dictionary of lists, then to R data.frame
  as.data.frame(pdf$to_dict("list"))
}

#Load the font that will be used in the plots

font_add_google('Roboto')
showtext_auto()

#Suppress simulation when knitting
knitr::opts_chunk$set(eval = FALSE, echo = TRUE)

```

Next, we load the necessary Python packages:

```{python python-setup}

# Perform check whether any packages are required and install if missing

import subprocess
import sys

def import_or_install(package):
    try:
        __import__(package)
    except ImportError:
        subprocess.check_call([sys.executable, '-m', 'pip', 'install', package])

import_or_install("dagsim")
import_or_install("numpy")
import_or_install("pandas")

# Import the necessary python packages
import dagsim.base as ds
import numpy as np
import pandas as pd

# Set simulation seed
np.random.seed(42)

# Suppress python output
import os
import warnings
warnings.simplefilter(action='ignore', category=FutureWarning)

f = open(os.devnull, 'w')
sys.stdout = f

```

# Create simulation functions

## Function for simulating scenario 1

First we create a function to simulate **scenario1**, i.e. the scenario without mediator-outcome confounding

```{python simulate-scenario-1}

# Specify the target path coefficients to be simulated

Target_Mean     =  80
Target_SD       =  9
Path_X0_LY0_1   =  6
Path_X0_CY_1    =  6/np.sqrt(19/9)
Path_RY0_Y0_1   =  np.sqrt(((Target_SD/0.9)**2-Target_SD**2)/Target_SD**2)
Path_LY0_Y0_1   =  1
Path_LY0_LY1_1  =  0.5
Path_Y0_cY1Y0_1 =  -1
Path_CY_LY1_1   =  0.5*np.sqrt(19/9)
Path_RY1_Y1_1   =  np.sqrt(((Target_SD/0.9)**2-Target_SD**2)/Target_SD**2)
Path_LY1_Y1_1   =  1
Path_Y1_cY1Y0_1 =  1

# Calculate covariances, in order to work out the correct size of error terms to ensure variables are standardised

Cov_LY0_CY_1   = (Path_X0_LY0_1*Path_X0_CY_1)

# Create functions to define each variable

# Sex (X0_1)

def sex_1(Null):
    X0_1 = 2*np.random.binomial(n=1, p=0.5)-1
    return X0_1

# Random baseline weight (RY0_1)

def R_baseline_weight_1 (Null):
    RY0_1 = np.random.normal(0, Target_SD)
    return RY0_1

# Random baseline weight 2 (RY0_2_1)

def R_baseline_weight_2_1 (Null):
    RY0_2_1 = np.random.normal(0, Target_SD)
    return RY0_2_1
  
# Latent baseline weight (LY0_1)

def L_baseline_weight_1(X0_1):
    LY0_1 = (Target_Mean 
             + X0_1*Path_X0_LY0_1
             + np.sqrt((Target_SD**2-Path_X0_LY0_1**2)/Target_SD**2)*np.random.normal(0, Target_SD))  
    return LY0_1

# Baseline weight (Y0_1)

def baseline_weight_1(LY0_1, RY0_1):
    Y0_1 = (  LY0_1*Path_LY0_Y0_1
            + RY0_1*Path_RY0_Y0_1)
    return Y0_1

# Baseline weight 2 (Y0_2_1)

def baseline_weight_2_1(LY0_1, RY0_2_1):
    Y0_2_1 = (LY0_1*Path_LY0_Y0_1
            + RY0_2_1*Path_RY0_Y0_1)
    return Y0_2_1

# Average baseline weight (Y0_avg_1)

def baseline_weight_avg_1(Y0_1, Y0_2_1):
    Y0_avg_1 = ((Y0_1 + Y0_2_1)/2)
    return Y0_avg_1
  
# Exogenous change (CY_1)

def exogenous_change_1 (X0_1):
    CY_1 = (  X0_1*Path_X0_CY_1
            + np.sqrt((Target_SD**2-Path_X0_CY_1**2)/Target_SD**2)*np.random.normal(0, Target_SD))
    return CY_1

# Random follow-up weight (RY1_1)

def R_follow_up_weight_1 (Null):
    RY1_1 = np.random.normal(0, 9)
    return RY1_1

# Latent follow-up weight (LY1_1)
    
def L_follow_up_weight_1(LY0_1, CY_1):
    LY1_1 = (  Target_Mean
             + (LY0_1-Target_Mean)*Path_LY0_LY1_1
             + CY_1*Path_CY_LY1_1)
    return LY1_1
    
# Follow_up weight (Y1_1)
    
def follow_up_weight_1(RY1_1, LY1_1):
    Y1_1 = (  LY1_1*Path_LY1_Y1_1
            + RY1_1*Path_RY1_Y1_1)
    return Y1_1

# Weight change (Y1_Y0_1)

def M_M_weight_change_1(Y0_1, Y1_1):
    Y1_Y0_1 = (  Y0_1*Path_Y0_cY1Y0_1
               + Y1_1*Path_Y1_cY1Y0_1)
    return Y1_Y0_1
  
# Weight change from average (Y1_Y0_avg_1)

def MM_M_weight_change_1(Y0_avg_1, Y1_1):
    Y1_Y0_avg_1 = (Y0_avg_1*Path_Y0_cY1Y0_1
               + Y1_1*Path_Y1_cY1Y0_1)
    return Y1_Y0_avg_1
  
# latent latent weight change (LY1_LY0_1)

def L_L_weight_change_1(LY0_1, LY1_1):
    LY1_LY0_1 = (  LY0_1*Path_Y0_cY1Y0_1
                 + LY1_1*Path_Y1_cY1Y0_1)
    return LY1_LY0_1

# latent measured weight change (Y1_LY0_1)

def L_M_weight_change_1(LY0_1, Y1_1):
    Y1_LY0_1 = Y1_1-LY0_1
    return Y1_LY0_1
  
# Single measured latent weight change (LY1_Y0_1)

def M_L_weight_change_1(Y0_1, LY1_1):
    LY1_Y0_1 = LY1_1-Y0_1
    return LY1_Y0_1

# Double measured latent weight change (LY1_Y0_avg_1)

def MM_L_weight_change_1(Y0_avg_1, LY1_1):
    LY1_Y0_avg_1 = LY1_1-Y0_avg_1
    return LY1_Y0_avg_1
  
# Create DagSim nodes for each variable based on the origin function

Null         = 0
X0_1         = ds.Node(name='sex',                       function=sex_1,                       args=[Null])
RY0_1        = ds.Node(name='R_baseline_weight',         function=R_baseline_weight_1,         args=[Null])
RY0_2_1      = ds.Node(name='R_baseline_weight_2',       function=R_baseline_weight_2_1,       args=[Null])
LY0_1        = ds.Node(name='L_baseline_weight',         function=L_baseline_weight_1,         args=[X0_1])
Y0_1         = ds.Node(name='baseline_weight',           function=baseline_weight_1,           args=[LY0_1,RY0_1])
Y0_2_1       = ds.Node(name='baseline_weight_2',         function=baseline_weight_2_1,         args=[LY0_1,RY0_2_1])
Y0_avg_1     = ds.Node(name='baseline_weight_avg',       function=baseline_weight_avg_1,       args=[Y0_1, Y0_2_1])
CY_1         = ds.Node(name='exogenous_change',          function=exogenous_change_1,          args=[X0_1])
RY1_1        = ds.Node(name='R_follow_up_weight',        function=R_baseline_weight_1,         args=[Null])
LY1_1        = ds.Node(name='L_follow_up_weight',        function=L_follow_up_weight_1,        args=[LY0_1, CY_1])
Y1_1         = ds.Node(name='follow_up_weight',          function=follow_up_weight_1,          args=[RY1_1, LY1_1])
Y1_Y0_1      = ds.Node(name='M_M_weight_change',         function=M_M_weight_change_1,         args=[Y0_1, Y1_1])
Y1_Y0_avg_1  = ds.Node(name='MM_M_weight_change',        function=MM_M_weight_change_1,        args=[Y0_avg_1, Y1_1])
LY1_LY0_1    = ds.Node(name='L_L_weight_change',         function=L_L_weight_change_1,         args=[LY0_1, LY1_1])
Y1_LY0_1     = ds.Node(name='L_M_weight_change',         function=L_M_weight_change_1,         args=[LY0_1, Y1_1])
LY1_Y0_1     = ds.Node(name='M_L_weight_change',         function=M_L_weight_change_1,         args=[Y0_1, LY1_1])
LY1_Y0_avg_1 = ds.Node(name='MM_L_weight_change',        function=MM_L_weight_change_1,        args=[Y0_avg_1, LY1_1])

# Declare that these nodes belong to a DAG
S1_graph = ds.Graph([X0_1,RY0_1,RY0_2_1, LY0_1,Y0_1,Y0_2_1, Y0_avg_1, CY_1,RY1_1, LY1_1, Y1_1, Y1_Y0_1, Y1_Y0_avg_1, LY1_LY0_1, Y1_LY0_1,LY1_Y0_1,LY1_Y0_avg_1], 'S1_graph')

```

## Function for simulating scenario 2

Next we create a function to simulate **scenario2**, i.e. the scenario with mediator-outcome confounding

```{python simulate-scenario-2}

# Specify the target path coefficients to be simulated

Path_X0_M0_2    =  5
Path_X0_LY0_2   =  9
Path_X0_CY_2    =  9/(np.sqrt(13/9))
Path_M0_LY0_2   = -0.6                   
Path_M0_CY_2    = -0.6/(np.sqrt(13/9))
Path_RY0_Y0_2   =  np.sqrt(((Target_SD/0.9)**2-Target_SD**2)/Target_SD**2)
Path_LY0_Y0_2   =  1
Path_LY0_LY1_2  =  0.5
Path_Y0_cY1Y0_2 =  -1
Path_CY_LY1_2   =  0.5*(np.sqrt(13/9))
Path_RY1_Y1_2   =  np.sqrt(((Target_SD/0.9)**2-Target_SD**2)/Target_SD**2)
Path_LY1_Y1_2   =  1
Path_Y1_cY1Y0_2 =  1
    
# Calculate covariances, in order to work out the correct size of error terms to ensure variables are standardised

Cov_X0_M0_2    =  Path_X0_M0_2
Cov_LY0_CY_2   = (Path_X0_LY0_2*Path_X0_CY_2)+(Path_X0_LY0_2*Path_X0_M0_2*Path_M0_CY_2)+(Path_M0_LY0_2*Path_M0_CY_2)

# Create functions to define each varaible

# Sex (X0_2)

def sex_2(Null):
    X0_2 = 2*np.random.binomial(n=1, p=0.5)-1
    return X0_2

# physical_activity (M0_2)

def physical_activity_2(X0_2):
    M0_2 = (30
            + X0_2*Path_X0_M0_2
            + np.sqrt((10**2-Path_X0_M0_2**2)/10**2)*np.random.normal(0, 10))
    return M0_2

# Random baseline weight (RY0_2)

def R_baseline_weight_2 (Null):
    RY0_2 = np.random.normal(0, Target_SD)
    return RY0_2

# Random baseline weight 2 (RY0_2_2)

def R_baseline_weight_2_2 (Null):
    RY0_2_2 = np.random.normal(0, Target_SD)
    return RY0_2_2

# Latent baseline weight (LY0_2)

def L_baseline_weight_2(X0_2, M0_2):
    LY0_2 = (Target_Mean  
             + X0_2*Path_X0_LY0_2
             + (M0_2-30)*Path_M0_LY0_2
             + np.sqrt((Target_SD**2
                        -Path_X0_LY0_2**2
                        -(100*Path_M0_LY0_2**2)
                        -2*Cov_X0_M0_2*Path_X0_LY0_2*Path_M0_LY0_2)/Target_SD**2)*np.random.normal(0, Target_SD))  
    return LY0_2

# Baseline Weight (Y0_2)

def baseline_weight_2(LY0_2, RY0_2):
    Y0_2 = (  LY0_2*Path_LY0_Y0_2
            + RY0_2*Path_RY0_Y0_2)
    return Y0_2

# Baseline Weight 2 (Y0_2_2)

def baseline_weight_2_2(LY0_2, RY0_2_2):
    Y0_2_2 = (LY0_2*Path_LY0_Y0_2
            + RY0_2_2*Path_RY0_Y0_2)
    return Y0_2_2

# Average baseline weight (Y0_avg_2)

def baseline_weight_avg_2(Y0_2, Y0_2_2):
    Y0_avg_2 = ((Y0_2 + Y0_2_2)/2)
    return Y0_avg_2
  
# Exogenous change (CY_2)

def exogenous_change_2 (X0_2,M0_2):
    CY_2 = (  X0_2*Path_X0_CY_2
            + (M0_2-30)*Path_M0_CY_2
            + np.sqrt((Target_SD**2
                        - Path_X0_CY_2**2
                        -(100*Path_M0_CY_2**2)
                        - 2*Cov_X0_M0_2*Path_X0_CY_2*Path_M0_CY_2)/Target_SD**2)*np.random.normal(0, Target_SD))
    return CY_2

# Random follow-up weight (RY1_2)

def R_follow_up_weight_2 (Null):
    RY1_2 = np.random.normal(0, Target_SD)
    return RY1_2

# Latent follow-up weight (LY1_2)

def L_follow_up_weight_2(LY0_2, CY_2):
    LY1_2 =   (  Target_Mean
               + (LY0_2-Target_Mean)*Path_LY0_LY1_2
               + CY_2*Path_CY_LY1_2)
    return LY1_2

# Follow_up weight (Y1_2)

def follow_up_weight_2(RY1_2, LY1_2):
    Y1_2 = (  RY1_2*Path_RY1_Y1_2
            + LY1_2*Path_LY1_Y1_2)
    return Y1_2

# Weight Change (Y1_Y0_2)
def M_M_weight_change_2(Y0_2, Y1_2):
    Y1_Y0_2 = (  Y0_2*Path_Y0_cY1Y0_2
               + Y1_2*Path_Y1_cY1Y0_2)
    return Y1_Y0_2

# Weight change from average (Y1_Y0_avg_2)

def MM_M_weight_change_2(Y0_avg_2, Y1_2):
    Y1_Y0_avg_2 = (Y0_avg_2*Path_Y0_cY1Y0_2
               + Y1_2*Path_Y1_cY1Y0_2)
    return Y1_Y0_avg_2
  
# Latent latent weight Change (LY1_LY0_2)
def L_L_weight_change_2(LY0_2, LY1_2):
    LY1_LY0_2 = (  LY0_2*Path_Y0_cY1Y0_2
                 + LY1_2*Path_Y1_cY1Y0_2)
    return LY1_LY0_2
  
# Latent Measured weight Change (Y1_LY0_2)

def L_M_weight_change_2(LY0_2, Y1_2):
    Y1_LY0_2 = Y1_2-LY0_2
    return Y1_LY0_2
  
# Measured Latent weight Change (LY1_Y0_2)

def M_L_weight_change_2(Y0_2, LY1_2):
    LY1_Y0_2 = LY1_2-Y0_2
    return LY1_Y0_2
  
# Double measured Latent weight Change (LY1_Y0_avg_2)

def MM_L_weight_change_2(Y0_avg_2, LY1_2):
    LY1_Y0_avg_2 = LY1_2-Y0_avg_2
    return LY1_Y0_avg_2
  
# Create DagSim nodes for each variable based on the origin function

Null         = 0
X0_2         = ds.Node(name='sex',                  function=sex_2,                 args=[Null])
M0_2         = ds.Node(name='physical_activity',    function=physical_activity_2,   args=[X0_2])
RY0_2        = ds.Node(name='R_baseline_weight',    function=R_baseline_weight_2,   args=[Null])
RY0_2_2      = ds.Node(name='R_baseline_weight_2',  function=R_baseline_weight_2_2, args=[Null])
LY0_2        = ds.Node(name='L_baseline_weight',    function=L_baseline_weight_2,   args=[X0_2,M0_2])
Y0_2         = ds.Node(name='baseline_weight',      function=baseline_weight_2,     args=[LY0_2,RY0_2])
Y0_2_2       = ds.Node(name='baseline_weight_2',    function=baseline_weight_2_2,   args=[LY0_2,RY0_2_2])
Y0_avg_2     = ds.Node(name='baseline_weight_avg',  function=baseline_weight_avg_2, args=[Y0_2,Y0_2_2])
CY_2         = ds.Node(name='exogenous_change',     function=exogenous_change_2,    args=[X0_2,M0_2])
RY1_2        = ds.Node(name='R_follow_up_weight',   function=R_baseline_weight_2,   args=[Null])
LY1_2        = ds.Node(name='L_follow_up_weight',   function=L_follow_up_weight_2,  args=[LY0_2,CY_2])
Y1_2         = ds.Node(name='follow_up_weight',     function=follow_up_weight_2,    args=[RY1_2,LY1_2])
Y1_Y0_2      = ds.Node(name='M_M_weight_change',    function=M_M_weight_change_2,   args=[Y0_2,Y1_2])
Y1_Y0_avg_2  = ds.Node(name='MM_M_weight_change',   function=MM_M_weight_change_2,  args=[Y0_avg_2,Y1_2])
LY1_LY0_2    = ds.Node(name='L_L_weight_change',    function=L_L_weight_change_2,   args=[LY0_2,LY1_2])
Y1_LY0_2     = ds.Node(name='L_M_weight_change',    function=L_M_weight_change_2,   args=[LY0_2, Y1_2])
LY1_Y0_2     = ds.Node(name='M_L_weight_change',    function=M_L_weight_change_2,   args=[Y0_2, LY1_2])
LY1_Y0_avg_2 = ds.Node(name='MM_L_weight_change',   function=MM_L_weight_change_2,  args=[Y0_avg_2, LY1_2])

# Declare that these nodes belong to a DAG
S2_graph = ds.Graph([X0_2,M0_2,RY0_2,RY0_2_2, LY0_2,Y0_2,Y0_2_2, Y0_avg_2, CY_2,RY1_2,LY1_2,Y1_2,Y1_Y0_2, Y1_Y0_avg_2, LY1_LY0_2, Y1_LY0_2,LY1_Y0_2,LY1_Y0_avg_2], 'S2_graph')

```

# Create Lord's Paradox Plots

Here, we will create plots - in the style of Lord's original figures - for the two scenarios.

## Simulate data for the figures

We begin by simulating data for the two scenarios using the `simulateS1` and `simulateS2` functions created above

```{python}
# For the figures, we will simulate datasets of 50,000 participants to maximize precision.
S1_data = pd.DataFrame(S1_graph.simulate(num_samples=50000))
S2_data = pd.DataFrame(S2_graph.simulate(num_samples=50000))
```

## Import simulated data into R and label sex variable

```{R import-simulated-data}

scenario1              <- pandas_to_r(py$S1_data)
scenario2              <- pandas_to_r(py$S2_data)

 scenario1              <- scenario1 %>% 
  transform(sex = factor(sex, levels = c(-1,1), labels=c("Female", "Male"))) 

 scenario2              <- scenario2 %>% 
  transform(sex = factor(sex, levels = c(-1,1), labels=c("Female", "Male"))) 

```

## Check the means and SDs are as expected

We expect to see overall means of 80kg for baseline and follow-up weight, with SDs of 9 for latent weight variables and 10 for measured weight variables. Between sex, we expect a difference of 12kg in weights, but 0kg in change.

```{R check-means-and-sds}

round(describe(scenario1[,c("L_baseline_weight",
                            "baseline_weight",
                            "baseline_weight_2",
                            "baseline_weight_avg",
                            "L_follow_up_weight",
                            "follow_up_weight",
                            "L_L_weight_change",
                            "M_M_weight_change",
                            "MM_M_weight_change")]),1)

round(describe(subset(scenario1, sex=="Female")[,c("L_baseline_weight",
                                                   "baseline_weight",
                                                   "baseline_weight_2",
                                                   "baseline_weight_avg",
                                                   "L_follow_up_weight",
                                                   "follow_up_weight",
                                                   "L_L_weight_change",
                                                   "M_M_weight_change",
                                                   "MM_M_weight_change")]),1)

round(describe(subset(scenario1, sex=="Male")[,c("L_baseline_weight",
                                                 "baseline_weight",
                                                 "baseline_weight_2",
                                                 "baseline_weight_avg",
                                                 "L_follow_up_weight",
                                                 "follow_up_weight",
                                                 "L_L_weight_change",
                                                 "M_M_weight_change",
                                                 "MM_M_weight_change")]),1)

round(describe(scenario2[,c("L_baseline_weight",
                            "baseline_weight",
                            "baseline_weight_2",
                            "baseline_weight_avg",
                            "L_follow_up_weight",
                            "follow_up_weight",
                            "L_L_weight_change",
                            "M_M_weight_change",
                            "MM_M_weight_change",
                            "physical_activity")]),1)

round(describe(subset(scenario2, sex=="Female")[,c("L_baseline_weight",
                                                   "baseline_weight",
                                                   "baseline_weight_2",
                                                   "baseline_weight_avg",
                                                   "L_follow_up_weight",
                                                   "follow_up_weight",
                                                   "L_L_weight_change",
                                                   "M_M_weight_change",
                                                   "MM_M_weight_change",
                                                   "physical_activity")]),1)

round(describe(subset(scenario2, sex=="Male")[,c("L_baseline_weight",
                                                 "baseline_weight",
                                                 "baseline_weight_2",
                                                 "baseline_weight_avg",
                                                 "L_follow_up_weight",
                                                 "follow_up_weight",
                                                 "L_L_weight_change",
                                                 "M_M_weight_change",
                                                 "MM_M_weight_change",
                                                 "physical_activity")]),1)

```

## Create Plot for Scenario 1

```{R plot-scenario-1, include=FALSE}
#This plot will be constructed from four panels, made up of two density plots of the baseline weight and follow-up weight distributions, the scatterplot of follow-up vs baseline weight, and a blank square 

# Define labels for the X (Y0) and Y (Y1) axes ----
y0_label                    <- expression(bold(paste(Y[0], ": Baseline weight (Kg)")))
y1_label                    <- expression(bold(paste(Y[1], ": Follow-up weight (Kg)")))

# Draw the first density plot, for baseline weight ----

left_histogram_s1   <- ggplot(scenario1) +
                              theme_classic(base_size = 16, 
                                            base_family="Roboto") +
                              theme(legend.position = "none",
                                            plot.margin = margin(0, -0.2, 0, 0, "mm"),
                                            plot.background = element_rect(fill = "white", linewidth=0),
                                            axis.ticks = element_blank(),
                                            axis.line.x = element_blank(),
                                            axis.line.y = element_blank(),
                                            axis.text.x = element_blank(),
                                            axis.text.y = element_blank(),
                                            axis.title.x = element_blank(),
                                            axis.title.y =element_blank(),
                                            text = element_text(family = "Roboto")) +
                            # geom_point(aes(y=40, x=-200), size=5, colour="black") + # alignment marks
                            # geom_point(aes(y=120, x=-200), size=5, colour="black") + # alignment marks
                              geom_density(data=subset(scenario1, sex=="Female"), 
                                           aes(y=follow_up_weight, x=-after_stat(count)), 
                                           bounds=c(40,120), 
                                           bw=2, 
                                           fill="#64197D", 
                                           color="#64197D", 
                                           linetype="dashed", 
                                           linewidth=1, 
                                           alpha=0.1) +
                              geom_density(data=subset(scenario1, sex=="Male"), 
                                           aes(y=follow_up_weight, x=-after_stat(count)),
                                           bw=2,
                                           bounds=c(40,120),
                                           fill="#64197D", 
                                           color="#64197D", 
                                           linetype="solid", 
                                           linewidth=1, 
                                           alpha=0.1) +
                              coord_cartesian(ylim=c(40,120), xlim=c(-1500,0), expand=FALSE) +
                              geom_segment(aes(y = 40, x = 0, yend = 120, xend = 0),
                                           color="#64197D", linewidth=1) +
                              annotate("text",
                                       y = 50,
                                       x = -400,
                                       label = "50",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 60,
                                       x = -400,
                                       label = "60",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 70,
                                       x = -400,
                                       label = "70",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 80,
                                       x = -400,
                                       label = "80",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 90,
                                       x = -400,
                                       label = "90",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 100,
                                       x = -400,
                                       label = "100",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 110,
                                       x = -400,
                                       label = "110",
                                       size = 8,
                                       colour="#64197D")

# Draw the second density plot, for follow-up weight ----

bottom_histogram_s1 <- ggplot(scenario1) +
                              theme_classic(base_size = 16, 
                                            base_family="Roboto") +
                              theme(legend.position = "none",
                                    plot.margin = margin(-1.2, 0, 0, -1.4, "mm"),
                                    plot.background = element_rect(fill = "white", linewidth=0),
                                    axis.ticks = element_blank(),
                                    axis.line.x = element_blank(),
                                    axis.line.y = element_blank(),
                                    axis.text.x = element_blank(),
                                    axis.text.y = element_blank(),
                                    axis.title.x = element_blank(),
                                    axis.title.y =element_blank(),
                                    text = element_text(family = "Roboto")) +
                             # geom_point(aes(x=40, y=-200), size=5, colour="black") + # alignment marks
                             # geom_point(aes(x=120, y=-200), size=5, colour="black") + # alignment marks
                               geom_density(data=subset(scenario1, sex=="Female"),  
                                            aes(x=baseline_weight, y=-after_stat(count)), 
                                            bounds=c(40,120), 
                                            bw=2, 
                                            fill="#C80032", 
                                            color="#C80032", 
                                            linetype="dashed", 
                                            linewidth=1, 
                                            alpha=0.1) +
                               geom_density(data=subset(scenario1, sex=="Male"), 
                                            aes(x=baseline_weight, y=-after_stat(count)), 
                                            bounds=c(40,120), 
                                            bw=2, 
                                            fill="#C80032", 
                                            color="#C80032", 
                                            linetype="solid", 
                                            linewidth=1, 
                                            alpha=0.1) +
                               coord_cartesian(xlim=c(40,120), ylim=c(-1500,0), expand=FALSE) +
                               geom_segment(aes(x = 40, y = 0, xend = 120, yend = 0),
                                            color="#C80032", linewidth=1) +
                               annotate("text",
                                        x = 50,
                                        y = -250,
                                        label = "50",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 60,
                                        y = -250,
                                        label = "60",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 70,
                                        y = -250,
                                        label = "70",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 80,
                                        y = -250, 
                                        label = "80",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 90,
                                        y = -250,
                                        label = "90",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 100,
                                        y = -250,
                                        label = "100",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 110,
                                        y = -250,
                                        label = "110", 
                                        size = 8,
                                        colour="#C80032")

# Draw the main scatterplot ----

scatter_s1          <- ggplot(scenario1, aes(x = baseline_weight, y = follow_up_weight)) +
                              theme_classic(base_size = 16, base_family="Roboto") +
                              theme(legend.position  = "none",
                                            plot.margin      = margin(0, 0, -0.5, -1.5, "mm"),
                                            plot.background  = element_rect(fill = "white", linewidth=0),
                                            axis.ticks       = element_blank(),
                                            axis.line.x      = element_blank(), 
                                            axis.line.y      = element_blank(),
                                            axis.text.x      = element_blank(),
                                            axis.text.y      = element_blank(), 
                                            axis.title.x     = element_blank(),
                                            axis.title.y     = element_blank(),
                                            text             = element_text(family = "Roboto")) +
                            # geom_point(aes(x=40, y=40), size=5, colour="black") + # alignment marks
                            # geom_point(aes(x=120, y=120), size=5, colour="black") + # alignment marks
                              geom_point(data=subset(scenario1, sex=="Female"), 
                                            size=0.5, 
                                            colour="#C83296", 
                                            alpha=0.1, 
                                            shape=16) +
                              geom_point(data=subset(scenario1, sex=="Male"), 
                                            size=0.5, 
                                            colour="#009632", 
                                            alpha=0.1, 
                                            shape=16) +
                              geom_abline(intercept = 0, 
                                            slope = 1, 
                                            color="black", 
                                            linewidth=0.5) +
                              stat_ellipse(data=subset(scenario1, sex=="Female"), 
                                            geom="polygon", 
                                            alpha=0.1, 
                                            fill="#C83296", 
                                            level = 0.995) +
                              stat_ellipse(data=subset(scenario1, sex=="Male"), 
                                            geom="polygon", 
                                            alpha=0.1, 
                                            fill="#009632", 
                                            level = 0.995) +
                              stat_ellipse(data=subset(scenario1, sex=="Female"), 
                                            colour="#C83296", 
                                            linetype="longdash", 
                                            linewidth=1, 
                                            level = 0.995) +
                              stat_ellipse(data=subset(scenario1, sex=="Male"), 
                                            colour="#009632", 
                                            linetype = "solid", 
                                            linewidth=1, 
                                            level = 0.995) +
                              geom_smooth(data=subset(scenario1, sex=="Female"),
                                            method="lm", 
                                            se = FALSE, 
                                            colour="#C83296", 
                                            linetype="dashed", 
                                            fullrange=TRUE) + 
                              geom_smooth(data=subset(scenario1, sex=="Male"),
                                            method="lm", 
                                            se = FALSE, 
                                            colour="#009632", 
                                            linetype="solid", 
                                            fullrange=TRUE) + 
                              geom_point(data=subset(scenario1, sex=="Female"), 
                                            aes(x = mean(baseline_weight), y = mean(follow_up_weight)), 
                                            size=6, 
                                            colour="#C83296", 
                                            shape=16) +
                              geom_point(data=subset(scenario1, sex=="Male"), 
                                            aes(x = mean(baseline_weight), y = mean(follow_up_weight)), 
                                            size=6, 
                                            colour="#009632", 
                                            shape=16) +
                              coord_cartesian(ylim = c(40,120), xlim=c(40,120),
                                              expand=FALSE) +
                              annotate("text",
                                       x = 100,
                                       y = 43,
                                       label = y0_label,
                                       size = 8,
                                       fontface ="bold",
                                       colour="#C80032") + 
                              annotate("text",
                                       x = 43,
                                       y = 100,
                                       label = y1_label,
                                       angle=90,
                                       size = 8,
                                       fontface ="bold",
                                       colour="#64197D") + 
                              annotate("text",
                                       x = 93,
                                       y = 102,
                                       label = "Boys",
                                       size = 8,
                                       fontface ="bold",
                                       colour="#009632") + 
                              annotate("text",
                                       x = 65,
                                       y = 58,
                                       label = "Girls",
                                       size = 8,
                                       fontface ="bold",
                                       colour="#C83296") +
                              geom_segment(aes(x = 40, y = 40, xend = 40, yend = 120),
                                           color="#64197D", linewidth=1) +
                              geom_segment(aes(x = 40, y = 40, xend = 120, yend = 40),
                                           color="#C80032", linewidth=1)
  
# Draw an empty plot for the final panel ----
empty               <- ggplot()+
                              geom_point(aes(1,1), colour="white")+
                              theme(legend.position = "none",
                              plot.margin = margin(0, 0, 0, 0, "mm"),
                              axis.ticks=element_blank(), 
                              panel.background=element_blank(), 
                              axis.text.x=element_blank(), 
                              axis.text.y=element_blank(),           
                              axis.title.x=element_blank(), 
                              axis.title.y=element_blank())

# Stitch together the final image from the four plots using grid.arrange ----

Lord_plot_s1 <- grid.arrange(left_histogram_s1, scatter_s1, empty, bottom_histogram_s1, 
                layout_matrix = matrix(c(1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         3,4,4,4,4,4),
                                       byrow=TRUE, ncol=6))

# Save the final image as a PNG ----

ggsave(paste0("Lord_plot_scenario1", ".png"), plot = Lord_plot_s1, units = "px", height = 3000, width = 3000, dpi=300)

```

## Create Plot for Scenario 2

```{R plot-scenario-2, include=FALSE}
#Again, this plot will be constructed from four panels, made up of two density plots of the baseline weight and follow-up weight distributions, the scatterplot of follow-up vs baseline weight, and a blank square 

# Draw the first density plot, for baseline weight ----

left_histogram_s2   <- ggplot(scenario2) +
                              theme_classic(base_size = 16, 
                                            base_family="Roboto") +
                              theme(legend.position = "none",
                                            plot.margin = margin(0, -0.2, 0, 0, "mm"),
                                            plot.background = element_rect(fill = "white", linewidth=0),
                                            axis.ticks = element_blank(),
                                            axis.line.x = element_blank(),
                                            axis.line.y = element_blank(),
                                            axis.text.x = element_blank(),
                                            axis.text.y = element_blank(),
                                            axis.title.x = element_blank(),
                                            axis.title.y =element_blank(),
                                            text = element_text(family = "Roboto")) +
                            # geom_point(aes(y=40, x=-200), size=5, colour="black") + # alignment marks
                            # geom_point(aes(y=120, x=-200), size=5, colour="black") + # alignment marks
                              geom_density(data=subset(scenario2, sex=="Female"), 
                                           aes(y=follow_up_weight, x=-after_stat(count)), 
                                           bounds=c(40,120), 
                                           bw=2, 
                                           fill="#64197D", 
                                           color="#64197D", 
                                           linetype="dashed", 
                                           linewidth=1, 
                                           alpha=0.1) +
                              geom_density(data=subset(scenario2, sex=="Male"), 
                                           aes(y=follow_up_weight, x=-after_stat(count)),
                                           bw=2,
                                           bounds=c(40,120),
                                           fill="#64197D", 
                                           color="#64197D", 
                                           linetype="solid", 
                                           linewidth=1, 
                                           alpha=0.1) +
                              coord_cartesian(ylim=c(40,120), xlim=c(-1500,0), expand=FALSE) +
                              geom_segment(aes(y = 40, x = 0, yend = 120, xend = 0),
                                           color="#64197D", linewidth=1) +
                              annotate("text",
                                       y = 50,
                                       x = -400,
                                       label = "50",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 60,
                                       x = -400,
                                       label = "60",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 70,
                                       x = -400,
                                       label = "70",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 80,
                                       x = -400,
                                       label = "80",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 90,
                                       x = -400,
                                       label = "90",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 100,
                                       x = -400,
                                       label = "100",
                                       size = 8,
                                       colour="#64197D") +
                              annotate("text",
                                       y = 110,
                                       x = -400,
                                       label = "110",
                                       size = 8,
                                       colour="#64197D")

# Draw the second density plot, for follow-up weight ----

bottom_histogram_s2 <- ggplot(scenario2) +
                              theme_classic(base_size = 16, 
                                            base_family="Roboto") +
                              theme(legend.position = "none",
                                    plot.margin = margin(-1.2, 0, 0, -1.4, "mm"),
                                    plot.background = element_rect(fill = "white", linewidth=0),
                                    axis.ticks = element_blank(),
                                    axis.line.x = element_blank(),
                                    axis.line.y = element_blank(),
                                    axis.text.x = element_blank(),
                                    axis.text.y = element_blank(),
                                    axis.title.x = element_blank(),
                                    axis.title.y =element_blank(),
                                    text = element_text(family = "Roboto")) +
                             # geom_point(aes(x=40, y=-200), size=5, colour="black") + # alignment marks
                             # geom_point(aes(x=120, y=-200), size=5, colour="black") + # alignment marks
                               geom_density(data=subset(scenario2, sex=="Female"),  
                                            aes(x=baseline_weight, y=-after_stat(count)), 
                                            bounds=c(40,120), 
                                            bw=2, 
                                            fill="#C80032", 
                                            color="#C80032", 
                                            linetype="dashed", 
                                            linewidth=1, 
                                            alpha=0.1) +
                               geom_density(data=subset(scenario2, sex=="Male"), 
                                            aes(x=baseline_weight, y=-after_stat(count)), 
                                            bounds=c(40,120), 
                                            bw=2, 
                                            fill="#C80032", 
                                            color="#C80032", 
                                            linetype="solid", 
                                            linewidth=1, 
                                            alpha=0.1) +
                               coord_cartesian(xlim=c(40,120), ylim=c(-1500,0), expand=FALSE) +
                               geom_segment(aes(x = 40, y = 0, xend = 120, yend = 0),
                                            color="#C80032", linewidth=1) +
                               annotate("text",
                                        x = 50,
                                        y = -250,
                                        label = "50",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 60,
                                        y = -250,
                                        label = "60",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 70,
                                        y = -250,
                                        label = "70",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 80,
                                        y = -250, 
                                        label = "80",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 90,
                                        y = -250,
                                        label = "90",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 100,
                                        y = -250,
                                        label = "100",
                                        size = 8,
                                        colour="#C80032") +
                               annotate("text",
                                        x = 110,
                                        y = -250,
                                        label = "110", 
                                        size = 8,
                                        colour="#C80032")

# Draw the main scatterplot ----

scatter_s2          <- ggplot(scenario2, aes(x = baseline_weight, y = follow_up_weight)) +
                              theme_classic(base_size = 16, base_family="Roboto") +
                              theme(legend.position  = "none",
                                            plot.margin      = margin(0, 0, -0.5, -1.5, "mm"),
                                            plot.background  = element_rect(fill = "white", linewidth=0),
                                            axis.ticks       = element_blank(),
                                            axis.line.x      = element_blank(), 
                                            axis.line.y      = element_blank(),
                                            axis.text.x      = element_blank(),
                                            axis.text.y      = element_blank(), 
                                            axis.title.x     = element_blank(),
                                            axis.title.y     = element_blank(),
                                            text             = element_text(family = "Roboto")) +
                            # geom_point(aes(x=40, y=40), size=5, colour="black") + # alignment marks
                            # geom_point(aes(x=120, y=120), size=5, colour="black") + # alignment marks
                              geom_point(data=subset(scenario2, sex=="Female"), 
                                            size=0.5, 
                                            colour="#C83296", 
                                            alpha=0.1, 
                                            shape=16) +
                              geom_point(data=subset(scenario2, sex=="Male"), 
                                            size=0.5, 
                                            colour="#009632", 
                                            alpha=0.1, 
                                            shape=16) +
                              geom_abline(intercept = 0, 
                                            slope = 1, 
                                            color="black", 
                                            linewidth=0.5) +
                              stat_ellipse(data=subset(scenario2, sex=="Female"), 
                                            geom="polygon", 
                                            alpha=0.1, 
                                            fill="#C83296", 
                                            level = 0.995) +
                              stat_ellipse(data=subset(scenario2, sex=="Male"), 
                                            geom="polygon", 
                                            alpha=0.1, 
                                            fill="#009632", 
                                            level = 0.995) +
                              stat_ellipse(data=subset(scenario2, sex=="Female"), 
                                            colour="#C83296", 
                                            linetype="longdash", 
                                            linewidth=1, 
                                            level = 0.995) +
                              stat_ellipse(data=subset(scenario2, sex=="Male"), 
                                            colour="#009632", 
                                            linetype = "solid", 
                                            linewidth=1, 
                                            level = 0.995) +
                              geom_smooth(data=subset(scenario2, sex=="Female"),
                                            method="lm", 
                                            se = FALSE, 
                                            colour="#C83296", 
                                            linetype="dashed", 
                                            fullrange=TRUE) + 
                              geom_smooth(data=subset(scenario2, sex=="Male"),
                                            method="lm", 
                                            se = FALSE, 
                                            colour="#009632", 
                                            linetype="solid", 
                                            fullrange=TRUE) + 
                              geom_point(data=subset(scenario2, sex=="Female"), 
                                            aes(x = mean(baseline_weight), y = mean(follow_up_weight)), 
                                            size=6, 
                                            colour="#C83296", 
                                            shape=16) +
                              geom_point(data=subset(scenario2, sex=="Male"), 
                                            aes(x = mean(baseline_weight), y = mean(follow_up_weight)), 
                                            size=6, 
                                            colour="#009632", 
                                            shape=16) +
                              coord_cartesian(ylim = c(40,120), xlim=c(40,120),
                                              expand=FALSE) +
                              annotate("text",
                                       x = 100,
                                       y = 43,
                                       label = y0_label,
                                       size = 8,
                                       fontface ="bold",
                                       colour="#C80032") + 
                              annotate("text",
                                       x = 43,
                                       y = 100,
                                       label = y1_label,
                                       angle=90,
                                       size = 8,
                                       fontface ="bold",
                                       colour="#64197D") + 
                              annotate("text",
                                       x = 93,
                                       y = 102,
                                       label = "Boys",
                                       size = 8,
                                       fontface ="bold",
                                       colour="#009632") + 
                              annotate("text",
                                       x = 65,
                                       y = 58,
                                       label = "Girls",
                                       size = 8,
                                       fontface ="bold",
                                       colour="#C83296") +
                              geom_segment(aes(x = 40, y = 40, xend = 40, yend = 120),
                                           color="#64197D", linewidth=1) +
                              geom_segment(aes(x = 40, y = 40, xend = 120, yend = 40),
                                           color="#C80032", linewidth=1)
  
# Stitch together the final image from the four plots using grid.arrange ----

Lord_plot_s2 <- grid.arrange(left_histogram_s2, scatter_s2, empty, bottom_histogram_s2, 
                layout_matrix = matrix(c(1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         1,2,2,2,2,2,
                                         3,4,4,4,4,4),
                                       byrow=TRUE, ncol=6))

# Save the final image as a PNG ----

ggsave(paste0("Lord_plot_scenario2", ".png"), plot = Lord_plot_s2, units = "px", height = 3000, width = 3000, dpi=300)

```

# Obtain effect estimates and coefficients

This section focuses on estimating and saving the results of various models for the two scenarios. The simulation is repeated 10,000 times to obtain simulation intervals.

## Preliminary preparations for simulation

First the python preliminaries

```{python}

# Set up empty dictionaries to store simulated datasets
s1_datasets={}
s2_datasets={}

#Specify the number of datasets to be created:
nsims_py = range(1,10001) # lower this to make it run quicker for tweaks

```

Next the R preliminaries

```{R}
# Set up empty dataframes to receive the estimates from each simulation, and their summary results

simulation_estimates        <- data.frame(s1mod1a=numeric(0),
                                          s1mod1b=numeric(0),
                                          s1mod1c=numeric(0),
                                          s1mod1d=numeric(0),
                                          s1mod1e=numeric(0),
                                          s1mod1f=numeric(0),
                                          s1mod2a=numeric(0),
                                          s1mod2b=numeric(0),
                                          s1mod2c=numeric(0),
                                          s1mod2d=numeric(0),
                                          s1mod2e=numeric(0),
                                          s1mod2f=numeric(0),
                                          s1mod4a=numeric(0),
                                          s1mod4b=numeric(0),
                                          s1mod4c=numeric(0),
                                          s1mod4d=numeric(0),
                                          s1mod4e=numeric(0),
                                          s1mod4f=numeric(0),
                                          s2mod1a=numeric(0),
                                          s2mod1b=numeric(0),
                                          s2mod1c=numeric(0),
                                          s2mod1d=numeric(0),
                                          s2mod1e=numeric(0),
                                          s2mod1f=numeric(0),
                                          s2mod2a=numeric(0),
                                          s2mod2b=numeric(0),
                                          s2mod2c=numeric(0),
                                          s2mod2d=numeric(0),
                                          s2mod2e=numeric(0),
                                          s2mod2f=numeric(0),
                                          s2mod3a=numeric(0),
                                          s2mod3b=numeric(0),
                                          s2mod3c=numeric(0),
                                          s2mod3d=numeric(0),
                                          s2mod3e=numeric(0),
                                          s2mod3f=numeric(0),
                                          s2mod4a=numeric(0),
                                          s2mod4b=numeric(0),
                                          s2mod4c=numeric(0),
                                          s2mod4d=numeric(0), 
                                          s2mod4e=numeric(0), 
                                          s2mod4f=numeric(0) 
                                          )

simulation_results          <- data.frame(model=character(0), 
                                          lower=numeric(0), 
                                          point=numeric(0), 
                                          upper=numeric(0))

#Obtain the number of simulations from the python nsims-py object  above
nsims_r = py$nsims_py$stop-py$nsims_py$start

```

## Conduct the simulations (nsims times)

Conduct the simulation in python

```{python}

for i in nsims_py:
  s1_name = 'scenario1_'+str(i) 
  s2_name = 'scenario2_'+str(i) 
  s1_datasets[s1_name] = pd.DataFrame(S1_graph.simulate(num_samples=1000))
  s2_datasets[s2_name] = pd.DataFrame(S2_graph.simulate(num_samples=1000))
  
```

Next import the simulated datasets into R and label the sex variable

```{R}

s1_list <- lapply(py$s1_datasets, pandas_to_r)
s2_list <- lapply(py$s2_datasets, pandas_to_r)

for (i in 1:nsims_r) {
  s1_list[[i]] <- s1_list[[i]] %>% 
    transform(sex = factor(sex, levels = c(-1,1), labels=c("Female", "Male")))
  
  s2_list[[i]] <- s2_list[[i]] %>% 
    transform(sex = factor(sex, levels = c(-1,1), labels=c("Female", "Male")))
}

```

## Run the models and store the estimates

Now run relevant models in each simulated dataset and store the results

```{R}

for (i in 1:nsims_r) {

# Model 1 Analysis of change-score

# Scenario 1: change score (latent follow up, latent baseline)  
s1mod1a            <- lm(L_L_weight_change ~ sex, data = s1_list[[i]])   
s1mod1a_estimate   <- s1mod1a$coefficients[2]

# Scenario 1: change score (latent follow up, single measured baseline) 
s1mod1b            <- lm(M_L_weight_change ~ sex, data = s1_list[[i]])   
s1mod1b_estimate   <- s1mod1b$coefficients[2]

# Scenario 1: change score (latent follow up, double measured baseline) 
s1mod1c            <- lm(MM_L_weight_change ~ sex, data = s1_list[[i]])   
s1mod1c_estimate   <- s1mod1c$coefficients[2]

# Scenario 1: change score (measured follow up, latent baseline) 
s1mod1d            <- lm(L_M_weight_change ~ sex, data = s1_list[[i]])   
s1mod1d_estimate   <- s1mod1d$coefficients[2]

# Scenario 1: change score (measured follow up, single measured baseline) 
s1mod1e            <- lm(M_M_weight_change ~ sex, data = s1_list[[i]])   
s1mod1e_estimate   <- s1mod1e$coefficients[2]

# Scenario 1: change score (measured follow up, double measured baseline) 
s1mod1f            <- lm(MM_M_weight_change ~ sex, data = s1_list[[i]])   
s1mod1f_estimate   <- s1mod1f$coefficients[2]

# Scenario 2: change score (latent follow up, latent baseline)  
s2mod1a            <- lm(L_L_weight_change ~ sex, data = s2_list[[i]])   
s2mod1a_estimate   <- s2mod1a$coefficients[2]

# Scenario 2: change score (latent follow up, single measured baseline) 
s2mod1b            <- lm(M_L_weight_change ~ sex, data = s2_list[[i]])   
s2mod1b_estimate   <- s2mod1b$coefficients[2]

# Scenario 2: change score (latent follow up, double measured baseline) 
s2mod1c            <- lm(MM_L_weight_change ~ sex, data = s2_list[[i]])   
s2mod1c_estimate   <- s2mod1c$coefficients[2]

# Scenario 2: change score (measured follow up, latent baseline) 
s2mod1d            <- lm(L_M_weight_change ~ sex, data = s2_list[[i]])   
s2mod1d_estimate   <- s2mod1d$coefficients[2]

# Scenario 2: change score (measured follow up, single measured baseline) 
s2mod1e            <- lm(M_M_weight_change ~ sex, data = s2_list[[i]])   
s2mod1e_estimate   <- s2mod1e$coefficients[2]

# Scenario 2: change score (measured follow up, single measured baseline) 
s2mod1f            <- lm(MM_M_weight_change ~ sex, data = s2_list[[i]])   
s2mod1f_estimate   <- s2mod1f$coefficients[2]

# Model 2: Analysis of follow-up adjusted for baseline

# Scenario 1: Latent follow-up, latent baseline

s1mod2a            <- lm(L_follow_up_weight ~ sex + L_baseline_weight, data = s1_list[[i]])
s1mod2a_estimate   <- s1mod2a$coefficients[2]

# Scenario 1: Latent follow-up, single measured baseline

s1mod2b            <- lm(L_follow_up_weight ~ sex + baseline_weight, data = s1_list[[i]])
s1mod2b_estimate   <- s1mod2b$coefficients[2]

# Scenario 1: Latent follow-up, double measured baseline

s1mod2c            <- lm(L_follow_up_weight ~ sex + baseline_weight_avg, data = s1_list[[i]])
s1mod2c_estimate   <- s1mod2c$coefficients[2]

# Scenario 1: Measured follow-up, latent baseline

s1mod2d            <- lm(follow_up_weight ~ sex + L_baseline_weight, data = s1_list[[i]])
s1mod2d_estimate   <- s1mod2d$coefficients[2]

# Scenario 1: Measured follow-up, single measured baseline

s1mod2e            <- lm(follow_up_weight ~ sex + baseline_weight, data = s1_list[[i]])
s1mod2e_estimate   <- s1mod2e$coefficients[2]

# Scenario 1: Measured follow-up, double measured baseline

s1mod2f            <- lm(follow_up_weight ~ sex + baseline_weight_avg, data = s1_list[[i]])
s1mod2f_estimate   <- s1mod2f$coefficients[2]

# Scenario 2: Latent follow-up, latent baseline

s2mod2a            <- lm(L_follow_up_weight ~ sex + L_baseline_weight, data = s2_list[[i]])
s2mod2a_estimate   <- s2mod2a$coefficients[2]

# Scenario 2: Latent follow-up, single measured baseline

s2mod2b            <- lm(L_follow_up_weight ~ sex + baseline_weight, data = s2_list[[i]])
s2mod2b_estimate   <- s2mod2b$coefficients[2]

# Scenario 2: Latent follow-up, double measured baseline

s2mod2c            <- lm(L_follow_up_weight ~ sex + baseline_weight_avg, data = s2_list[[i]])
s2mod2c_estimate   <- s2mod2c$coefficients[2]

# Scenario 2: Measured follow-up, latent baseline

s2mod2d            <- lm(follow_up_weight ~ sex + L_baseline_weight, data = s2_list[[i]])
s2mod2d_estimate   <- s2mod2d$coefficients[2]

# Scenario 2: Measured follow-up, single measured baseline

s2mod2e            <- lm(follow_up_weight ~ sex + baseline_weight, data = s2_list[[i]])
s2mod2e_estimate   <- s2mod2e$coefficients[2]

# Scenario 2: Measured follow-up, double measured baseline

s2mod2f            <- lm(follow_up_weight ~ sex + baseline_weight_avg, data = s2_list[[i]])
s2mod2f_estimate   <- s2mod2f$coefficients[2]

# Model 3: g-computation

# Scenario 2: Latent follow-up, latent baseline

invisible(capture.output(
s2mod3a            <- cmest(data = s2_list[[i]],
                         model="gformula",
                         exposure = "sex",
                         mediator = c("L_baseline_weight"),
                         mreg = list("linear"),
                         postc=c("physical_activity"),
                         postcreg=list("linear"),
                         outcome = "L_follow_up_weight", 
                         yreg = "linear",
                         EMint = FALSE,
                         a = "Male",
                         astar = "Female",
                         mval = list(80), nboot = 1)))

s2mod3a_estimate   <- s2mod3a$effect.pe[1]

# Scenario 2: Latent follow-up, single measured baseline

invisible(capture.output(
s2mod3b            <- cmest(data = s2_list[[i]],
                         model="gformula",
                         exposure = "sex",
                         mediator = c("baseline_weight"),
                         mreg = list("linear"),
                         postc=c("physical_activity"),
                         postcreg=list("linear"),
                         outcome = "L_follow_up_weight", 
                         yreg = "linear",
                         EMint = FALSE,
                         a = "Male",
                         astar = "Female",
                         mval = list(80), nboot = 1)))

s2mod3b_estimate   <- s2mod3b$effect.pe[1]

# Scenario 2: Latent follow-up, double measured baseline

invisible(capture.output(
s2mod3c            <- cmest(data = s2_list[[i]],
                         model="gformula",
                         exposure = "sex",
                         mediator = c("baseline_weight_avg"),
                         mreg = list("linear"),
                         postc=c("physical_activity"),
                         postcreg=list("linear"),
                         outcome = "L_follow_up_weight", 
                         yreg = "linear",
                         EMint = FALSE,
                         a = "Male",
                         astar = "Female",
                         mval = list(80), nboot = 1)))

s2mod3c_estimate   <- s2mod3c$effect.pe[1]

# Scenario 2: Measured follow-up, latent baseline

invisible(capture.output(
s2mod3d            <- cmest(data = s2_list[[i]],
                         model="gformula",
                         exposure = "sex",
                         mediator = c("L_baseline_weight"),
                         mreg = list("linear"),
                         postc=c("physical_activity"),
                         postcreg=list("linear"),
                         outcome = "follow_up_weight", 
                         yreg = "linear",
                         EMint = FALSE,
                         a = "Male",
                         astar = "Female",
                         mval = list(80), nboot = 1)))

s2mod3d_estimate   <- s2mod3d$effect.pe[1]

# Scenario 2: Measured follow-up, single measured baseline

invisible(capture.output(
s2mod3e            <- cmest(data = s2_list[[i]],
                         model="gformula",
                         exposure = "sex",
                         mediator = c("baseline_weight"),
                         mreg = list("linear"),
                         postc=c("physical_activity"),
                         postcreg=list("linear"),
                         outcome = "follow_up_weight", 
                         yreg = "linear",
                         EMint = FALSE,
                         a = "Male",
                         astar = "Female",
                         mval = list(80), nboot = 1)))

s2mod3e_estimate   <- s2mod3e$effect.pe[1]

# Scenario 2: Measured follow-up, double measured baseline

invisible(capture.output(
s2mod3f            <- cmest(data = s2_list[[i]],
                         model="gformula",
                         exposure = "sex",
                         mediator = c("baseline_weight_avg"),
                         mreg = list("linear"),
                         postc=c("physical_activity"),
                         postcreg=list("linear"),
                         outcome = "follow_up_weight", 
                         yreg = "linear",
                         EMint = FALSE,
                         a = "Male",
                         astar = "Female",
                         mval = list(80), nboot = 1)))

s2mod3f_estimate   <- s2mod3f$effect.pe[1]

# Model 4: Analysis of change-score adjusted for baseline

# Scenario 1: Latent follow-up, latent baseline

s1mod4a            <- lm(L_L_weight_change ~ sex + L_baseline_weight, data = s1_list[[i]])
s1mod4a_estimate   <- s1mod4a$coefficients[2]

# Scenario 1: Latent follow-up, single measured baseline

s1mod4b            <- lm(M_L_weight_change ~ sex + baseline_weight, data = s1_list[[i]])
s1mod4b_estimate   <- s1mod4b$coefficients[2]

# Scenario 1: Latent follow-up, double measured baseline

s1mod4c            <- lm(MM_L_weight_change ~ sex + baseline_weight_avg, data = s1_list[[i]])
s1mod4c_estimate   <- s1mod4c$coefficients[2]

# Scenario 1: measured follow-up, latent baseline

s1mod4d            <- lm(L_M_weight_change ~ sex + L_baseline_weight, data = s1_list[[i]])
s1mod4d_estimate   <- s1mod4d$coefficients[2]

# Scenario 1: measured follow-up, single measured baseline

s1mod4e            <- lm(M_M_weight_change ~ sex + baseline_weight, data = s1_list[[i]])
s1mod4e_estimate   <- s1mod4e$coefficients[2]

# Scenario 1: measured follow-up, single measured baseline

s1mod4f            <- lm(MM_M_weight_change ~ sex + baseline_weight_avg, data = s1_list[[i]])
s1mod4f_estimate   <- s1mod4f$coefficients[2]

# Scenario 2: Latent follow-up, latent baseline

s2mod4a            <- lm(L_L_weight_change ~ sex + L_baseline_weight, data = s2_list[[i]])
s2mod4a_estimate   <- s2mod4a$coefficients[2]

# Scenario 2: Latent follow-up, single measured baseline

s2mod4b            <- lm(M_L_weight_change ~ sex + baseline_weight, data = s2_list[[i]])
s2mod4b_estimate   <- s2mod4b$coefficients[2]

# Scenario 2: Latent follow-up, double measured baseline

s2mod4c            <- lm(MM_L_weight_change ~ sex + baseline_weight_avg, data = s2_list[[i]])
s2mod4c_estimate   <- s2mod4c$coefficients[2]

# Scenario 2: measured follow-up, latent baseline

s2mod4d            <- lm(L_M_weight_change ~ sex + L_baseline_weight, data = s2_list[[i]])
s2mod4d_estimate   <- s2mod4d$coefficients[2]

# Scenario 2: measured follow-up, single measured baseline

s2mod4e            <- lm(M_M_weight_change ~ sex + baseline_weight, data = s2_list[[i]])
s2mod4e_estimate   <- s2mod4e$coefficients[2]

# Scenario 2: measured follow-up, double measured baseline

s2mod4f            <- lm(MM_M_weight_change ~ sex + baseline_weight_avg, data = s2_list[[i]])
s2mod4f_estimate   <- s2mod4f$coefficients[2]

# Save local vectors into dataframe

simulation_estimates[nrow(simulation_estimates)+1,]  <- c(s1mod1a_estimate, 
                                                          s1mod1b_estimate,
                                                          s1mod1c_estimate,
                                                          s1mod1d_estimate,
                                                          s1mod1e_estimate,
                                                          s1mod1f_estimate,
                                                          s1mod2a_estimate,
                                                          s1mod2b_estimate,
                                                          s1mod2c_estimate,
                                                          s1mod2d_estimate,
                                                          s1mod2e_estimate,
                                                          s1mod2f_estimate,
                                                          s1mod4a_estimate, 
                                                          s1mod4b_estimate, 
                                                          s1mod4c_estimate, 
                                                          s1mod4d_estimate, 
                                                          s1mod4e_estimate, 
                                                          s1mod4f_estimate, 
                                                          s2mod1a_estimate, 
                                                          s2mod1b_estimate,
                                                          s2mod1c_estimate,
                                                          s2mod1d_estimate, 
                                                          s2mod1e_estimate, 
                                                          s2mod1f_estimate, 
                                                          s2mod2a_estimate,
                                                          s2mod2b_estimate,
                                                          s2mod2c_estimate,
                                                          s2mod2d_estimate,
                                                          s2mod2e_estimate,
                                                          s2mod2f_estimate,
                                                          s2mod3a_estimate, 
                                                          s2mod3b_estimate,
                                                          s2mod3c_estimate,
                                                          s2mod3d_estimate,
                                                          s2mod3e_estimate,
                                                          s2mod3f_estimate,
                                                          s2mod4a_estimate, 
                                                          s2mod4b_estimate,
                                                          s2mod4c_estimate,
                                                          s2mod4d_estimate, 
                                                          s2mod4e_estimate, 
                                                          s2mod4f_estimate
                                                          )
# Drop local vectors
rm(s1mod1a_estimate, s1mod1b_estimate, s1mod1c_estimate, s1mod1d_estimate, s1mod1e_estimate, s1mod1f_estimate, s1mod2a_estimate, s1mod2b_estimate, s1mod2c_estimate, s1mod2d_estimate, s1mod2e_estimate, s1mod2f_estimate, s1mod4a_estimate, s1mod4b_estimate, s1mod4c_estimate, s1mod4d_estimate, s1mod4e_estimate, s1mod4f_estimate, s2mod1a_estimate, s2mod1b_estimate, s2mod1c_estimate, s2mod1d_estimate, s2mod1e_estimate, s2mod1f_estimate, s2mod2a_estimate, s2mod2b_estimate, s2mod2c_estimate, s2mod2d_estimate, s2mod2e_estimate, s2mod2f_estimate, s2mod3a_estimate, s2mod3b_estimate, s2mod3c_estimate, s2mod3d_estimate, s2mod3e_estimate, s2mod3f_estimate, s2mod4a_estimate, s2mod4b_estimate, s2mod4c_estimate, s2mod4d_estimate, s2mod4e_estimate, s2mod4f_estimate)


}

```

## Extract the median and 95% simulation limits for each model

Finally, extract the medians and simulation limits for each quantity and output into a table

```{R}
model_names                 <- list("S1 - Mod 1a: Unadjusted change-score (latent Y1, latent Y0)",
                                    "S1 - Mod 1b: Unadjusted change-score (latent Y1, single measured Y0)",
                                    "S1 - Mod 1c: Unadjusted change-score (latent Y1, double measured Y0)",
                                    "S1 - Mod 1d: Unadjusted change-score (measured Y1, latent Y0)",
                                    "S1 - Mod 1e: Unadjusted change-score (measured Y1, single measured Y0)",
                                    "S1 - Mod 1f: Unadjusted change-score (measured Y1, double measured Y0)",
                                    "S1 - Mod 2a: Adjusted follow-up (latent Y1, latent Y0)",
                                    "S1 - Mod 2b: Adjusted follow-up (latent Y1, single measured Y0)",
                                    "S1 - Mod 2c: Adjusted follow-up (latent Y1, double measured Y0)",
                                    "S1 - Mod 2d: Adjusted follow-up (measured Y1, latent Y0)",
                                    "S1 - Mod 2e: Adjusted follow-up (measured Y1, single measured Y0)",
                                    "S1 - Mod 2f: Adjusted follow-up (measured Y1, double measured Y0)",
                                    "S1 - Mod 4a: Adjusted change-score (latent Y1, latent Y0)",
                                    "S1 - Mod 4b: Adjusted change-score (latent Y1, single measured Y0)",
                                    "S1 - Mod 4c: Adjusted change-score (latent Y1, double measured Y0)",
                                    "S1 - Mod 4d: Adjusted change-score (measured Y1, latent Y0)",
                                    "S1 - Mod 4e: Adjusted change-score (measured Y1, single measured Y0)",
                                    "S1 - Mod 4f: Adjusted change-score (measured Y1, double measured Y0)",
                                    "S2 - Mod 1a: Unadjusted change-score (latent Y1, latent Y0)",
                                    "S2 - Mod 1b: Unadjusted change-score (latent Y1, single measured Y0)",
                                    "S2 - Mod 1c: Unadjusted change-score (latent Y1, double measured Y0)",
                                    "S2 - Mod 1d: Unadjusted change-score (measured Y1, latent Y0)",
                                    "S2 - Mod 1e: Unadjusted change-score (measured Y1, single measured Y0)",
                                    "S2 - Mod 1f: Unadjusted change-score (measured Y1, double measured Y0)",
                                    "S2 - Mod 2a: Adjusted follow-up (latent Y1, latent Y0)",
                                    "S2 - Mod 2b: Adjusted follow-up (latent Y1, single measured Y0)",
                                    "S2 - Mod 2c: Adjusted follow-up (latent Y1, double measured Y0)",
                                    "S2 - Mod 2d: Adjusted follow-up (measured Y1, latent Y0)",
                                    "S2 - Mod 2e: Adjusted follow-up (measured Y1, single measured Y0)",
                                    "S2 - Mod 2f: Adjusted follow-up (measured Y1, double measured Y0)",
                                    "S2 - Mod 3a: g-computation (latent Y1, latent Y0)",
                                    "S2 - Mod 3b: g-computation (latent Y1, single measured Y0)",
                                    "S2 - Mod 3c: g-computation (latent Y1, double measured Y0)",
                                    "S2 - Mod 3d: g-computation (measured Y1, latent Y0)",
                                    "S2 - Mod 3e: g-computation (measured Y1, single measured Y0)",
                                    "S2 - Mod 3f: g-computation (measured Y1, double measured Y0)",
                                    "S2 - Mod 4a: Adjusted change-score (latent Y1, latent Y0)",
                                    "S2 - Mod 4b: Adjusted change-score (latent Y1, single measured Y0)",
                                    "S2 - Mod 4c: Adjusted change-score (latent Y1, double measured Y0)",
                                    "S2 - Mod 4d: Adjusted change-score (measured Y1, latent Y0)",
                                    "S2 - Mod 4e: Adjusted change-score (measured Y1, single measured Y0)",
                                    "S2 - Mod 4f: Adjusted change-score (measured Y1, double measured Y0)"
                                    )
for (j in 1:42) {
  
centiles      <- c(round(quantile(simulation_estimates[,j], 0.025), digits=2),
                   round(quantile(simulation_estimates[,j], 0.5), digits=2),
                   round(quantile(simulation_estimates[,j], 0.975),digits=2))

simulation_results[nrow(simulation_results)+1,]  <- c(model_names[j],
                                                      unname(as.list(centiles)))
rm(centiles)
}

# View and save the results ----
write.csv(simulation_results, "lords_paradox_simulation_results.csv")
```
